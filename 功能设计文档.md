# 贴纸生成器功能设计文档

## 1. 项目概述

本项目是一个基于TypeScript + React的前端贴纸生成工具，核心功能包括：
- 画布编辑（添加贴纸、文字）
- 贴纸库管理
- 图像编辑与抠图
- 模板创建与应用
- 数据持久化与导出

## 2. 整体UI布局

采用经典的三栏布局，确保操作流程清晰直观：

### 2.1 左侧面板：资源管理区
- 包含两个标签页：
  - **贴纸库列表**：显示所有创建/导入的贴纸库文件
  - **模板列表**：显示所有创建/导入的模板文件

#### 2.1.1 贴纸库列表
- 每个库项包含：
  - 库名称
  - 贴纸数量
  - 缩略图预览区
- 操作按钮：
  - 新建贴纸库（保存为文件）
  - 导入贴纸库（从本地文件加载）
  - 导出贴纸库（保存到本地文件）
  - 编辑库信息
  - 删除贴纸库文件

#### 2.1.2 模板列表
- 每个模板项包含：
  - 模板名称
  - 画布尺寸
  - 缩略图预览区
- 操作按钮：
  - 新建模板（保存为文件）
  - 导入模板（从本地文件加载）
  - 导出模板（保存到本地文件）
  - 编辑模板
  - 删除模板文件
  - 应用模板到画布

### 2.2 右侧面板

#### 2.2.1 图层面板（上半部分）
- 显示当前画布的所有图层
- 每个图层项包含：
  - 图层类型图标（贴纸/文字）
  - 图层名称
  - 可见性切换
  - 锁定状态
  - 选中状态
- 操作按钮：
  - 新建图层（贴纸/文字）
  - 删除选中图层
  - 上移/下移图层

#### 2.2.2 元素属性面板（下半部分）
- 根据选中图层类型动态显示属性：
  - **贴纸属性**：位置（X/Y）、大小（宽/高）、旋转角度、透明度
  - **文字属性**：内容、字体选择、字号、颜色、对齐方式（左/中/右/两端）

### 2.3 中间区域：可编辑画布
- 支持鼠标拖拽、缩放查看
- 实时显示所有图层内容
- 元素操作：
  - 拖拽调整位置
  - 边角拖拽调整大小
  - 选中显示操作手柄

## 3. 核心功能模块

### 3.1 画布管理

#### 3.1.1 新建画布
- 预设尺寸：A4（210x297mm）、A5、自定义
- 自定义尺寸支持：宽度、高度、单位（px/mm）、背景色

#### 3.1.2 打开画布
- 支持从本地加载保存的画布JSON文件
- 自动恢复所有图层和属性

#### 3.1.3 保存画布
- 保存为**编辑格式**：JSON文件（包含所有图层、属性、画布信息）
- 导出为**图像格式**：PNG（透明背景）/JPG（白色背景）

### 3.2 元素编辑

#### 3.2.1 贴纸元素
- 从左侧库列表拖拽到画布
- 支持：
  - 鼠标拖拽移动位置
  - 边角拖拽缩放大小
  - 选中状态下旋转
  - 单独的图层管理

#### 3.2.2 文字元素
- 通过图层面板的「新建文字图层」添加
- 支持：
  - 文本内容编辑
  - 字体选择（系统字体/自定义字体）
  - 字号调整
  - 颜色选择
  - 对齐方式设置
  - 同样支持拖拽、缩放、旋转

### 3.3 贴纸库管理

#### 3.3.1 库文件操作
- **新建库**：创建新的贴纸库并自动保存为JSON文件
- **导入库**：从本地文件系统加载贴纸库文件
- **导出库**：将贴纸库保存为JSON文件到本地
- **编辑库**：修改库名称、描述等信息并保存到文件
- **删除库**：从本地文件系统中删除贴纸库文件

#### 3.3.2 贴纸操作
- **添加贴纸**：从图像编辑器保存生成贴纸并添加到当前选中的库文件
- **删除贴纸**：单个或批量删除库中的贴纸，并更新库文件
- **编辑贴纸**：修改贴纸名称、备注、自定义字段，并更新库文件
- **预览贴纸**：在库文件中预览所有贴纸的缩略图

### 3.4 图像编辑

#### 3.4.1 打开图片
- 支持上传本地图片（PNG/JPG/JPEG）
- 显示原始图片供编辑

#### 3.4.2 背景色去除（抠图）
- 通过色彩范围选择：
  - 点击取色器选择背景色
  - 调整容差值（0-100）控制选择范围
  - 实时预览抠图效果

#### 3.4.3 选区编辑
- 矩形选区：框选区域删除像素
- 自由选区：手动绘制选区删除像素
- 反选：选择非透明区域

#### 3.4.4 保存为贴纸
- 自动裁剪到非透明区域边界
- 输入贴纸名称、备注
- 选择保存的目标库

### 3.5 模板系统

#### 3.5.1 模板管理
- **查看模板**：在左侧模板列表中显示所有模板文件，支持缩略图预览
- **新建模板**：创建新模板并保存为文件
- **导入模板**：从本地文件加载模板
- **导出模板**：将模板保存到本地文件
- **编辑模板**：修改模板的画布尺寸和布局
- **删除模板**：从本地文件系统中删除模板

#### 3.5.2 模板创建
- 设置画布尺寸（预设/自定义）
- 布局方式：
  - 网格布局（行列数、间距、对齐方式）
  - 自定义布局（手动添加贴纸占位符，设置位置、大小）
- 预览：实时查看模板效果
- 保存：输入名称、描述，保存为模板文件到本地

#### 3.5.3 模板应用
- 从模板列表中选择模板
- 自动生成对应尺寸的空白画布
- 按照模板布局自动创建贴纸占位符或直接排列贴纸
- 支持在应用后调整元素位置和大小

## 4. 数据结构设计

### 4.1 画布数据（JSON）
```typescript
interface CanvasData {
  id: string;
  width: number;
  height: number;
  backgroundColor: string;
  layers: LayerData[];
  createdAt: string;
  updatedAt: string;
}
```

### 4.2 图层数据
```typescript
interface LayerData {
  id: string;
  type: 'sticker' | 'text';
  name: string;
  visible: boolean;
  locked: boolean;
  opacity: number;
  transform: {
    x: number;
    y: number;
    width: number;
    height: number;
    rotation: number;
  };
  content: StickerContent | TextContent;
}
```

### 4.3 贴纸内容
```typescript
interface StickerContent {
  libraryId: string;
  stickerId: string;
}
```

### 4.4 文字内容
```typescript
interface TextContent {
  text: string;
  font: string;
  fontSize: number;
  color: string;
  alignment: 'left' | 'center' | 'right' | 'justify';
}
```

### 4.5 贴纸库数据
```typescript
interface StickerLibrary {
  id: string;
  name: string;
  description: string;
  stickers: StickerData[];
  createdAt: string;
  updatedAt: string;
}
```

### 4.6 贴纸数据
```typescript
interface StickerData {
  id: string;
  name: string;
  note: string;
  imageData: string; // Base64编码的透明PNG
  width: number;
  height: number;
  customFields?: Record<string, any>;
}
```

### 4.7 模板数据
```typescript
interface TemplateData {
  id: string;
  name: string;
  description: string;
  canvasSize: { width: number; height: number };
  layout: { type: 'grid'; rows: number; cols: number; spacing: number } | { type: 'custom'; placeholders: Placeholder[] };
}
```

## 5. 数据持久化

### 5.1 文件存储机制
- **贴纸库**：所有贴纸库均以独立JSON文件形式存储，包含完整的库信息和贴纸Base64数据
- **模板**：所有模板均以独立JSON文件形式存储，包含模板配置和布局信息
- **画布**：画布数据默认保存在浏览器内存中，可手动保存为JSON文件到本地

### 5.2 文件操作功能
- **新建保存**：创建新的贴纸库/模板时自动保存为文件
- **导入**：从本地文件系统加载贴纸库/模板
- **导出**：将贴纸库/模板保存到本地文件系统
- **删除**：从本地文件系统中删除选定的贴纸库/模板文件

### 5.3 临时存储
- 正在编辑的画布数据保存在浏览器内存中
- 支持自动保存草稿到浏览器`localStorage`（可配置自动保存间隔）
- 草稿数据在关闭浏览器后可恢复

## 6. 交互流程示例

### 6.1 创建新贴纸流程
1. 点击「图像编辑」按钮
2. 上传本地图片
3. 使用色彩范围工具去除背景
4. 使用选区工具微调
5. 点击「保存为贴纸」
6. 输入名称、备注，选择目标库
7. 贴纸添加到库中

### 6.2 创建画布并添加元素流程
1. 点击「新建画布」选择A4尺寸
2. 从左侧库拖拽贴纸到画布
3. 调整位置、大小
4. 点击图层面板「新建文字」
5. 输入文本，调整字体和大小
6. 保存画布为JSON文件

### 6.3 使用模板流程
1. 点击「创建模板」
2. 设置A4尺寸和3x3网格布局
3. 保存模板
4. 点击「应用模板」选择新建的模板
5. 自动生成带占位符的画布
6. 将贴纸拖拽到占位符位置
7. 保存或导出

## 7. 技术选型

### 7.1 核心框架
- React 18 + TypeScript
- 状态管理：Zustand
- 画布渲染：HTML5 Canvas API

### 7.2 关键依赖
- `react-color`：颜色选择器
- `react-rnd`：拖拽缩放组件
- `canvas-datagrid`：图层列表（可选）
- `file-saver`：文件保存功能
- `jszip`：库文件压缩（可选）

## 8. 扩展性考虑

- 支持多画布切换
- 贴纸批量导入
- 历史记录与撤销/重做
- 支持更多图像编辑工具（滤镜、旋转）

以上设计严格围绕您提到的功能点展开，确保覆盖所有需求。请您确认功能是否完善，如有调整或补充，我会进一步修改设计。